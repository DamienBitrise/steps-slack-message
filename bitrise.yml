format_version: 1.1.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  # define these in your .bitrise.secrets.yml
  - SLACK_WEBHOOK_URL: $SLACK_WEBHOOK_URL
  - SLACK_CHANNEL: $SLACK_CHANNEL

workflows:

  # ----------------------------------------
  # --- Tests

  test:
    steps:
    - path::./:
        title: On Success
        is_skippable: false
        inputs:
        - webhook_url: $SLACK_WEBHOOK_URL
        - channel: $SLACK_CHANNEL
        - from_username: step-dev-test
        - formatting_mode: "attachment"
        - message: |
            First, On Success test - attachment formatting mode

            Multiline, with a link: https://www.bitrise.io ,
            and _some_ *highlight*
        - color: good
    - path::./:
        title: On Success
        is_skippable: false
        inputs:
        - webhook_url: $SLACK_WEBHOOK_URL
        - channel: $SLACK_CHANNEL
        - from_username: step-dev-test
        - formatting_mode: "text"
        - message: |
            First, On Success test - text formatting mode

            Multiline, with a link: https://www.bitrise.io ,
            and _some_ *highlight*
        - color: good
    - path::./:
        title: On Success - without channel
        is_skippable: false
        inputs:
        - webhook_url: $SLACK_WEBHOOK_URL
        - channel: ''
        - from_username: step-dev-test
        - message: On Success test - without channel param
        - color: warning
    - path::./:
        title: On Success
        description: |-
          Overwrite the emoji parameter with an Icon URL input.
        is_skippable: false
        inputs:
        - webhook_url: $SLACK_WEBHOOK_URL
        - channel: $SLACK_CHANNEL
        - from_username: step-dev-test-2
        - message: The Icon URL should be used instead of the Emoji input!
        - emoji: ":white_check_mark:"
        - icon_url: https://bitrise-public-content-production.s3.amazonaws.com/slack/bitrise-slack-icon-128.png
        - is_debug_mode: "yes"
        - color: "#00ff00"

  missing-webhook-url-test:
    steps:
    - path::./:
        is_skippable: false
        inputs: []
  invalid-channel-test:
    steps:
    - path::./:
        is_skippable: false
        inputs:
        - webhook_url: $SLACK_WEBHOOK_URL
        - channel: 'no-channel-like-this'

  fail-message-test:
    steps:
    - script:
        title: Fail
        inputs:
        - content: exit 1
    - path::./:
        title: On Error
        is_skippable: false
        inputs:
        - webhook_url: $SLACK_WEBHOOK_URL
        - channel: $SLACK_CHANNEL
        - from_username_on_error: step-dev-test-ON-ERROR
        - message: On Error TEST

  # ----------------------------------------
  # --- Utility / Development

  do-vendor-update:
    steps:
    - script:
        inputs:
        - content: |
            #!/bin/bash
            set -ex
            go get -u -v github.com/tools/godep
            rm -rf ./Godeps
            rm -rf ./vendor
            go get -t -d ./...
            godep save ./...
